{% extends 'base.html.twig' %}

{% block title %}Estad칤sticas de la Comunidad{% endblock %}

{% block body %}
    <style>
        .stats-header {
            background: linear-gradient(135deg, #1d428a 0%, #143066 100%);
            color: white;
            padding: 60px 0;
            text-align: center;
            margin-bottom: 40px;
        }

        .category-card {
            border: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            height: 100%;
            overflow: hidden;
        }

        .category-card:hover {
            transform: translateY(-5px);
        }

        .cat-title {
            background-color: #cf5606;
            color: white;
            padding: 15px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            margin: 0;
        }

        /* Estilos para el TOP 3 */
        .list-group-item {
            border-left: 5px solid transparent;
            transition: background 0.2s;
        }

        .top-1 { border-left-color: #FFD700; background-color: #fffbef; } /* Oro */
        .top-2 { border-left-color: #C0C0C0; } /* Plata */
        .top-3 { border-left-color: #CD7F32; } /* Bronce */

        /* Estilo para la caja de Posici칩n Media */
        .avg-rank-box {
            text-align: center;
            min-width: 75px; /* Un poco m치s ancho para que quepa el texto de votos */
        }
        .avg-rank-number {
            font-size: 1.3rem;
            font-weight: 800;
            line-height: 1;
            color: #1d428a;
        }
        .avg-rank-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #888;
            margin-top: 2px;
        }
        .vote-count {
            font-size: 0.6rem;
            color: #999;
            margin-top: 2px;
            font-style: italic;
        }
    </style>

    <div class="stats-header">
        <div class="container">
            <h1 class="display-4 fw-bold text-uppercase">Estad칤sticas Globales</h1>
            <p class="lead opacity-75">Posici칩n media de cada jugador seg칰n los rankings de la comunidad</p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            {% for data in statsData %}
                {% set category = data.category %}
                {% set players = data.players %}

                <div class="col-lg-6 mb-4">
                    <div class="category-card card">
                        <h3 class="cat-title">{{ category.name }}</h3>

                        <div class="card-body p-0">
                            {% if players is empty %}
                                <div class="p-5 text-center text-muted">
                                    <i class="fas fa-chart-bar fa-3x mb-3 text-secondary opacity-25"></i>
                                    <p>No hay datos suficientes a칰n.</p>
                                </div>
                            {% else %}
                                <ul class="list-group list-group-flush">
                                    {# Mostramos TOP 10 #}
                                    {% for player in players|slice(0, 10) %}

                                        {# 1. Calculamos la media de posici칩n para esta categor칤a #}
                                        {% set avgRank = player.getAverageRank(category) %}

                                        {# 2. Calculamos MANUALMENTE cu치ntos votos tiene en esta categor칤a para mostrarlo #}
                                        {% set voteCount = 0 %}
                                        {% for r in player.userRankings %}
                                            {% if r.category.id == category.id %}
                                                {% set voteCount = voteCount + 1 %}
                                            {% endif %}
                                        {% endfor %}

                                        {# Solo mostramos si alguien lo ha rankeado (menor a 999) #}
                                        {% if avgRank < 999 %}

                                            {# Definir clases para los primeros 3 #}
                                            {% set rankClass = '' %}
                                            {% if loop.index == 1 %} {% set rankClass = 'top-1' %}
                                            {% elseif loop.index == 2 %} {% set rankClass = 'top-2' %}
                                            {% elseif loop.index == 3 %} {% set rankClass = 'top-3' %}
                                            {% endif %}

                                            <li class="list-group-item d-flex align-items-center justify-content-between py-3 {{ rankClass }}">
                                                <div class="d-flex align-items-center">
                                                    <span class="fw-bold text-muted me-3" style="font-size: 1.2rem; width: 25px;">
                                                        {{ loop.index }}
                                                    </span>

                                                    <div class="me-3" style="width: 45px; height: 45px; border-radius: 50%; overflow: hidden; background: #eee;">
                                                        {% if player.image %}
                                                            <img src="{{ player.image starts with 'http' ? player.image : asset('uploads/images/' ~ player.image) }}"
                                                                 style="width: 100%; height: 100%; object-fit: cover;">
                                                        {% else %}
                                                            <div class="d-flex align-items-center justify-content-center h-100 small">游</div>
                                                        {% endif %}
                                                    </div>

                                                    <div>
                                                        <a href="{{ path('app_element_show', {'id': player.id}) }}" class="text-decoration-none text-dark fw-bold d-block" style="line-height: 1.2;">
                                                            {{ player.name }}
                                                        </a>
                                                        <small class="text-uppercase text-muted" style="font-size: 0.75rem;">{{ player.team }}</small>
                                                    </div>
                                                </div>

                                                <div class="avg-rank-box">
                                                    <div class="avg-rank-number">
                                                        #{{ avgRank|number_format(1) }}
                                                    </div>
                                                    <div class="avg-rank-label">
                                                        Pos. Media
                                                    </div>
                                                    <div class="vote-count">
                                                        ({{ voteCount }} voto{{ voteCount != 1 ? 's' : '' }})
                                                    </div>
                                                </div>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>

                                {# Mensaje si hay m치s jugadores ocultos #}
                                {% if players|length > 10 %}
                                    <div class="card-footer bg-white text-center py-3 border-0">
                                        <small class="text-muted">... y {{ players|length - 10 }} jugadores m치s</small>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12 text-center py-5">
                    <div class="alert alert-warning">
                        No hay categor칤as creadas para mostrar estad칤sticas.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
